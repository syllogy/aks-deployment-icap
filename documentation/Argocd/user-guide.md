## Overview

This will give you an overview of how to deploy apps, how to sync apps using Argocd, how to get the context for each argocd cluster and also how to add the context to your argocd cli tool.

## Table of contents
- [Overview](#overview)
- [Table of contents](#table-of-contents)
  - [Login using CLI or GUI](#login-using-cli-or-gui)
  - [Accessing the Argo CD API Server](#accessing-the-argo-cd-api-server)
    - [CLI Login](#cli-login)
    - [GUI Login](#gui-login)
  - [ArgoCD Kube Contexts](#argocd-kube-contexts)
  - [Syncing Apps using Argocd](#syncing-apps-using-argocd)
  - [Register a Cluster to Deploy apps to](#register-a-cluster-to-deploy-apps-to)
  - [Check status of ArgoCD apps](#check-status-of-argocd-apps)
    - [Sync an ArgoCD app](#sync-an-argocd-app)
  - [ArgoCD Cheat Sheet](#argocd-cheat-sheet)
    - [Sync single or multiple apps](#sync-single-or-multiple-apps)
    - [Delete single or all apps](#delete-single-or-all-apps)
    - [Add context for easy switching between clusters](#add-context-for-easy-switching-between-clusters)

### Login using CLI or GUI

### Accessing the Argo CD API Server

Run the following to get the public IP:

```bash
kubectl get svc argocd-server

NAME            TYPE           CLUSTER-IP   EXTERNAL-IP    PORT(S)                      AGE
argocd-server   LoadBalancer   x.x.x.xxx   xxx.xx.xxx.xx   80:32117/TCP,443:30284/TCP   4d1h
```

Then if you go to the public IP you will be met by the login screen for ArgoCD

#### CLI Login

The password that is autogenerated to be the pod name of the Argo CD API Server. You can add this to an environment variable, using the below:

```bash
ARGOPASS=$(kubectl get pods -l app.kubernetes.io/name=argocd-server -o name -n argocd | cut -d'/' -f 2)
```

Next add the variable for the public IP address:

```bash
ARGOIP=$(kubectl get svc argocd-server -n argocd -o jsonpath="{.status.loadBalancer.ingress[*].ip}")
```

Using the username "admin" and the password above, login using the public IP of ArgoCD

```bash
argocd login $ARGOIP --name argocd-delivery-server --username admin --password $ARGOPASS --insecure
```

Once you're logged in you have full access to all the Argocd CLI commands and can deploy new charts or sync existing charts.

#### GUI Login

Pretty simple - go to the public IP and use the username "admin" and the password from the below command:

```bash
kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server -o name | cut -d'/' -f 2
```

### ArgoCD Kube Contexts

Use the following to get both ArgoCD server contexts

```bash
az aks get-credentials --resource-group <resource group here> --name <cluster name here>

az aks get-credentials --resource-group <resource group here> --name <cluster name here>
```

### Syncing Apps using Argocd 

It's very simple syncing apps using Argocd and can be done with maximum of two commands!

Firstly make sure you're using the correct context for the cluster you want to sync changes to.

```bash
‚ùØ argocd context
CURRENT  NAME                 SERVER
         argo-command-server  xx.xx.xxx.xxx
*        argo-test-server     xx.xx.xxx.xxx
```

If you're unsure which server is holding your cluster you can choose either one and run the following:

```bash
argocd app list | grep <name of cluster>
```

This will show you all the apps on the server under the cluster name you added to grep.

Next run following:

```bash
argocd context <name of context>
```

Now you're on the correct context, next you'll need to find the apps you want to sync. Using the same command as above we can find a list of all the apps.

```bash
argocd app list | grep <name of cluster>
```

The output will look similar to below: 

```bash
cert-manager-uks-develop                 https://gw-icap-uks-develop-k8s-856ef0c3.hcp.uksouth.azmk8s.io:443       default                  default  OutOfSync  Healthy      <none>      SharedResourceWarning(6)            https://github.com/filetrust/icap-infrastructure  cert-manager-chart       develop
icap-adaptation-service-uks-develop      https://gw-icap-uks-develop-k8s-856ef0c3.hcp.uksouth.azmk8s.io:443       icap-adaptation          default  OutOfSync  Healthy      <none>      <none>                              https://github.com/filetrust/icap-infrastructure  adaptation               develop
icap-administration-service-uks-develop  https://gw-icap-uks-develop-k8s-856ef0c3.hcp.uksouth.azmk8s.io:443       icap-administration      default  Synced     Healthy      <none>      <none>                              https://github.com/filetrust/icap-infrastructure  administration           develop
monitoring-grafana-uks-develop           https://gw-icap-uks-develop-k8s-856ef0c3.hcp.uksouth.azmk8s.io:443       icap-central-monitoring  default  OutOfSync  Degraded     <none>      <none>                              https://github.com/filetrust/icap-infrastructure  helm-charts/grafana/     develop
monitoring-uks-develop                   https://gw-icap-uks-develop-k8s-856ef0c3.hcp.uksouth.azmk8s.io:443       icap-central-monitoring  default  Synced     Progressing  <none>      <none>                              https://github.com/filetrust/icap-infrastructure  helm-charts/prometheus   develop
ncfs-uks-develop                         https://gw-icap-uks-develop-k8s-856ef0c3.hcp.uksouth.azmk8s.io:443       icap-ncfs                default  OutOfSync  Missing      <none>      <none>                              https://github.com/filetrust/icap-infrastructure  ncfs                     develop
rabbitmq-operator-uks-develop            https://gw-icap-uks-develop-k8s-856ef0c3.hcp.uksouth.azmk8s.io:443       icap-rabbit-operator     default  OutOfSync  Healthy      <none>      <none>                              https://github.com/filetrust/icap-infrastructure  rabbitmq-operator        develop
```

You can then copy the name, so in the case above I'm looking for all services running on ```gw-icap-uks-develop``` and then say you wanted to sync the adapatation service, you would use the below command.

```bash
argocd app sync icap-adaptation-service-uks-develop --prune
```

Allow it to complete and if it states no errors, then the newest commit into that branch will be synced into the services.

***FYI you can sync multiple apps by adding multiple apps one after another***

### Register a Cluster to Deploy apps to

This is required if you want to deploy to external clusters using ArgoCD. Follow the below to add clusters:

```bash
argocd cluster add
```

Choose a context name from the list and supply it to the following command:

```bash
argocd cluster add <context name>
```

The above command installs a ServiceAccount (argocd-manager), into the kube-system namespace of that kubectl context, and binds the service account to an admin-level ClusterRole. Argo CD uses this service account token to perform its management tasks (i.e. deploy/monitoring).


### Check status of ArgoCD apps

If you want to check the status of an ArgoCD app you would use the following:
```bash
argocd app list 

NAME                        CLUSTER                                                 NAMESPACE              PROJECT  STATUS     HEALTH    SYNCPOLICY  CONDITIONS  REPO                                              PATH                   TARGET
adaptation-service-main     https://gw-icap-k8s-f17703a9.hcp.uksouth.azmk8s.io:443  icap-adaptation        default  Synced     Healthy   <none>      <none>      https://github.com/filetrust/icap-infrastructure  adaptation             main
management-ui-main          https://gw-icap-k8s-f17703a9.hcp.uksouth.azmk8s.io:443  management-ui          default  Synced     Healthy   <none>      <none>      https://github.com/filetrust/icap-infrastructure  management-ui          main
policy-management-api-main  https://gw-icap-k8s-f17703a9.hcp.uksouth.azmk8s.io:443  icap-adaptation        default  Synced     Degraded  <none>      <none>      https://github.com/filetrust/icap-infrastructure  policy-management-api  main
rabbitmq-main               https://gw-icap-k8s-f17703a9.hcp.uksouth.azmk8s.io:443  icap-adaptation        default  Synced     Healthy   <none>      <none>      https://github.com/filetrust/icap-infrastructure  rabbitmq               main
transaction-event-api-main  https://gw-icap-k8s-f17703a9.hcp.uksouth.azmk8s.io:443  transaction-event-api  default  OutOfSync  Healthy   <none>      <none>      https://github.com/filetrust/icap-infrastructure  transactioneventapi    main
```

The status bar tells if you if its "synced" or "out of sync" and you can also see the health of the deployments as well.

#### Sync an ArgoCD app

When new features are added you can easily sync these to the current cluster by using the simple command below:

```bash
argocd app sync adaptation-service-main
```

This will sync the new changes that have been merged into the "main" branch of the "icap-infrastructure" repo. It will output any errors and give you a status of the app at completion.

### ArgoCD Cheat Sheet

#### Sync single or multiple apps 

Sync single apps
```
argodcd app sync <app service name>

Sync all apps
```bash
argocd app list -o name | xargs argocd app sync
```

#### Delete single or all apps

Delete a single app
```
argocd app sync
```

Delete all apps
```
argocd app list -o name | xargs argocd app sync
```

#### Add context for easy switching between clusters

Firstly you will need to get the public IP address of the Argocd server

```
kubectl get svc -n argocd argocd-server
```

Then you can use the following command to login but it will also add it to the context as well

```
argocd login -n <name of cluster or context> <Argo Server IP or hostname>
```
Now when you run the following it will show output the contexts you can change too. 
```
argocd context
CURRENT  NAME      SERVER
         North-Eu  xxx.xxx.xxx.xxx
         US-East   xxx.xxx.xxx.xxx
*        UK-South  xxx.xxx.xxx.xxx
```